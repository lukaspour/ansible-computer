---
- name: Remove old versions
  apt:
    pkg="{{item}}"
    state=absent
    update_cache=true
    purge=yes
  become: true
  with_items:
    - docker
    - docker-engine
    - docker.io

- name: Add repository key
  apt_key:
    url: "https://download.docker.com/linux/ubuntu/gpg"
    state: present

- name: Add source repository
  apt_repository:
    repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu xenial stable
    state: present

- name: Install docker
  apt:
    pkg="{{item}}"
    state=latest 
    cache_valid_time=3600 
    update_cache=true
    force=no
  become: true
  with_items:
    - docker-ce

- name: Ensure docker-compose is installed and available
  get_url: 
    url : https://github.com/docker/compose/releases/download/1.16.1/docker-compose-{{ ansible_system }}-{{ ansible_userspace_architecture }}
    dest: /usr/local/bin/docker-compose
    mode: '0755'

- name: Install docker-compose bash completion
  get_url: 
    url : https://raw.githubusercontent.com/docker/compose/1.15.0/contrib/completion/bash/docker-compose
    dest: /etc/bash_completion.d/docker-compose
    mode: '0644'

- name: allow this user to run docker as root
  command: usermod -aG docker {{ username }}
  become: true

